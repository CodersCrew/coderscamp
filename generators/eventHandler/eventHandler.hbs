import { Injectable, OnApplicationBootstrap, OnModuleDestroy } from '@nestjs/common';
import { CommandBus } from '@nestjs/cqrs';

import { ApplicationEvent } from '@/module/application-command-events';
import {
  {{properCase command}}ApplicationCommand,
  {{properCase command}}Command,
} from '@/module/commands/{{dashCase command}}';
import { {{properCase event}} } from '@/module/events/{{dashCase event}}.domain-event';
import { ApplicationCommandFactory } from '@/write/shared/application/application-command.factory';
import { EventsSubscription } from '@/write/shared/application/events-subscription/events-subscription';
import { EventsSubscriptionsRegistry } from '@/write/shared/application/events-subscription/events-subscriptions-registry';

@Injectable()
export class {{properCase event}}EventHandler implements OnApplicationBootstrap, OnModuleDestroy {
  private eventsSubscription: EventsSubscription;

  constructor(
    private readonly commandBus: CommandBus,
    private readonly commandFactory: ApplicationCommandFactory,
    private readonly eventsSubscriptionsFactory: EventsSubscriptionsRegistry,
  ) {}

  async onApplicationBootstrap() {
    this.eventsSubscription = this.eventsSubscriptionsFactory
      .subscription('')
      .onEvent<{{properCase event}}>('{{properCase event}}', (event) =>
        this.on{{properCase event}}(event),
      )
      .build();
    await this.eventsSubscription.start();
  }

  async onModuleDestroy() {
    await this.eventsSubscription.stop();
  }

  async on{{properCase event}}(event: ApplicationEvent<{{properCase event}}>) {
    const command = this.commandFactory.applicationCommand((idGenerator) => ({
      class: {{properCase command}}ApplicationCommand,
      ...{{properCase command}}Command({
        
      }),
      metadata: { correlationId: event.metadata.correlationId, causationId: event.id },
    }));

    await this.commandBus.execute(command);
  }  
}